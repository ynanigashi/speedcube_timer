# Speedcube Timer - 開発ロードマップ

このドキュメントは、Speedcube Timerの詳細な実装計画を記載しています。

## 目次
- [実装進捗サマリー](#実装進捗サマリー)
- [フェーズ別実装計画](#フェーズ別実装計画)
  - [Phase 1: 基盤構築](#phase-1-基盤構築--完了)
  - [Phase 1.5: 複数アルゴリズム対応](#phase-15-複数アルゴリズム対応--完了)
  - [Phase 2: 手動選択モード](#phase-2-手動パターン選択モード--完了)
  - [Phase 3: ランダムモード](#phase-3-ランダムモード--完了)
  - [Phase 4: プリセット連続実行](#phase-4-プリセット複数連続実行モード-)
  - [Phase 5: カスタムセット機能](#phase-5-カスタムセット機能-)
  - [Phase 6: 統計・最適化](#phase-6-統計表示と最適化-)
- [フェーズ間の依存関係](#フェーズ間の依存関係)
- [各フェーズ完了時の状態](#各フェーズ完了時の状態)
- [実装すべき項目（全体リスト）](#実装すべき項目全体リスト)
- [タイマー機能の拡充](#タイマー機能の拡充)

---

## 実装進捗サマリー

| 項目 | 状態 | 詳細 |
|-----|------|-----|
| パターンデータ | ✅ 完了 | 78パターン（OLL: 57, PLL: 21）（JSON管理） |
| アルゴリズムデータ | ✅ 完了 | 複数アルゴリズム対応（JSON管理） |
| データベース | ✅ 完了 | `pattern_solves`, `user_pattern_preferences`, `user_algorithm_ratings` |
| 統計メソッド | ✅ 完了 | パターン・アルゴリズム別基本統計、ユーザー設定管理 |
| UI実装（Phase 2） | ✅ 完了 | パターン選択・アルゴリズム選択・評価画面 |
| 状態ハンドラ（Phase 2） | ✅ 完了 | パターンモード用ハンドラ群、循環・ページ送り機能 |
| カテゴリタブ（Phase 2） | ✅ 完了 | TABキーでOLL/PLL切り替え |
| ページ送り（Phase 2） | ✅ 完了 | 左右キーで5件単位ページ送り、循環機能 |
| RANDタブ（Phase 3） | ✅ 完了 | RAND/PLL/OLLタブ、OLL/PLL/ALLランダム選択、重複回避 |
| 連続ランダム（Phase 3） | ✅ 完了 | 完了後SPACE連打で連続練習、ESCで終了 |
| 連続実行モード | 🔄 未着手 | プリセット・カスタムセット |
| パターン統計画面 | 🔄 未着手 | 詳細統計・グラフ表示 |

---

## フェーズ別実装計画

パターン習得モードを段階的に実装するため、以下の6フェーズに分けて開発を進めます。各フェーズは独立してテスト・デプロイ可能な単位としています。

**Phase 1: 基盤構築** ✅ **完了** - データ構造とDB準備  
**Phase 1.5: 複数アルゴリズム対応** ✅ **完了** - アルゴリズム選択・評価機能の設計  
**Phase 2: 手動選択モード** ✅ **完了** - パターン練習が可能（アルゴリズム選択・評価含む）  
**Phase 3: ランダムモード** ✅ **完了** - ランダム練習が可能  
**Phase 4: プリセット連続実行** 🔄 目標：カテゴリ全体練習が可能  
**Phase 5: カスタムセット機能** 🔄 目標：オリジナルセット作成が可能  
**Phase 6: 統計・最適化** 🔄 目標：全機能統合・洗練

---

### Phase 1: 基盤構築 📋 ✅ **完了**

**目標**: パターンデータ構造とデータベース基盤の準備  
**成果物**: パターン定義、DB拡張、基本クラス

**実装項目**:
- [x] パターンデータ構造の設計
  - [x] `Pattern`クラスの実装（`patterns.py`）
  - [x] パターンマスターデータの定義（最初は5-10パターンで検証）
  - [x] カテゴリ定数の定義
- [x] データベーススキーマの拡張
  - [x] `pattern_solves`テーブルの作成（`algorithm_id`カラム含む）
  - [x] インデックスの作成（3つ）
  - [x] 既存DBとの互換性確認
- [x] 基本的な統計メソッドの実装
  - [x] `get_pattern_times(pattern_id)`
  - [x] `get_pattern_best(pattern_id)`
  - [x] `get_pattern_count(pattern_id)`
- [x] 状態定義の追加
  - [x] `TimerState`に`PATTERN_READY`を追加（最小限）

**テスト**:
- [x] パターンデータの読み込みテスト
- [x] DBテーブル作成の確認
- [x] 統計メソッドの単体テスト

**成果**:
- 10パターン実装（OLL: 5, PLL: 3, F2L: 2）
- `pattern_solves`テーブルと3つのインデックス作成完了
- 基本統計メソッド3つ実装完了
- テストスクリプト作成・全テスト合格

---

### Phase 1.5: 複数アルゴリズム対応 🔧 ✅ **完了**

**目標**: 1パターンに複数のアルゴリズムを関連付け、ユーザーが選択・評価できる機能  
**成果物**: アルゴリズム管理機能、JSON読み込み、ユーザー設定DB

**背景**: ユーザーが「PLL_Uaのアルゴリズムが自分のと違う」と指摘したことから、1パターンに複数のアルゴリズムを持たせる設計に変更。

**実装項目**:
- [x] アルゴリズムデータ構造の設計
  - [x] `Algorithm`クラスの実装（`patterns.py`）
  - [x] `pattern_id`による紐付け
  - [x] `is_default`フラグでデフォルトアルゴリズム管理
  - [x] `speed_rating`, `ergonomics_rating`フィールド
- [x] JSONファイルによるマスターデータ管理
  - [x] `data/patterns.json`の作成（78パターン）
  - [x] `data/algorithms.json`の作成（アルゴリズム）
  - [x] JSON読み込み機能の実装
  - [x] フォールバック機能（JSON読み込み失敗時）
- [x] アルゴリズム管理メソッドの実装
  - [x] `get_algorithm(algorithm_id)`
  - [x] `get_algorithms_for_pattern(pattern_id)`
  - [x] `get_default_algorithm(pattern_id)`
  - [x] `has_multiple_algorithms(pattern_id)`
  - [x] `get_all_algorithms()`
- [x] データベーススキーマの拡張
  - [x] `pattern_solves`テーブルに`algorithm_id`カラム追加
  - [x] アルゴリズム別統計メソッド実装
- [x] ユーザー設定用テーブルの設計
  - [x] `user_pattern_preferences`テーブル設計（選択したアルゴリズム）
  - [x] `user_algorithm_ratings`テーブル設計（評価・お気に入り）

**成果**:
- 78パターンの完全なJSON管理
- アルゴリズム別統計メソッド実装完了
- 全テスト合格

**データ設計**:
```
【マスターデータ（JSON）】
patterns.json       → パターン定義（不変）
algorithms.json     → アルゴリズム定義（不変）

【ユーザーデータ（SQLite）】
pattern_solves              → 練習記録（algorithm_id含む）
user_pattern_preferences    → ユーザーが選択したアルゴリズム
user_algorithm_ratings      → アルゴリズムの評価・お気に入り
```

---

### Phase 2: 手動パターン選択モード ✅ **完了**

**目標**: パターンを選択して練習できる機能（アルゴリズム選択含む）  
**成果物**: パターン選択→アルゴリズム選択→練習→記録→評価の一連の流れ

**実装項目**:
- [x] データベース拡張
  - [x] `user_pattern_preferences`テーブル作成
  - [x] `user_algorithm_ratings`テーブル作成
  - [x] ユーザー設定管理メソッド（4メソッド）
- [x] 状態管理の拡張（`states.py`）
  - [x] `PATTERN_LIST_SELECT`、`PATTERN_ALGORITHM_SELECT`、`PATTERN_READY`、`PATTERN_FINISH`状態
- [x] UI実装（`renderer.py`）
  - [x] パターン一覧画面、アルゴリズム選択画面、準備画面、結果画面
- [x] 状態ハンドラ実装（`state_handlers.py`）
  - [x] 各状態のハンドラ実装
- [x] ナビゲーション機能
  - [x] TABキーでカテゴリ切り替え、ページ送り、循環ナビゲーション
- [x] データ記録（`log_handler.py`）
  - [x] パターン解法記録、ユーザー設定の保存

**成果**:
- 78パターン（OLL: 57, PLL: 21）を効率的にナビゲート
- アルゴリズム選択・評価機能の完全実装
- ユーザー設定の永続化

---

### Phase 3: ランダムモード 🎲 ✅ **完了**

**目標**: カテゴリからランダムにパターンを抽出して連続練習  
**成果物**: RANDタブによるランダム練習機能

**設計コンセプト**:
- パターン選択画面のカテゴリタブに「RAND」を追加
- 既存のOLL/PLLタブと同じ感覚で使える統一UI
- 連続ランダム練習機能（SPACE で次のランダムパターン）

**実装項目**:
- [x] ランダム選択メソッドの実装（重複回避機能付き）
- [x] ランダムモード用の状態変数追加
- [x] RANDタブのUI実装
- [x] 状態ハンドラの拡張（ランダムモード対応）
- [x] 重複回避ロジック（最大5パターン記憶）

**成果物**: 
- RANDタブによる統一されたUI
- OLL/PLL/ALLからのランダム選択
- 連続ランダム練習機能
- 重複回避機能（最近5パターンを除外）

---

### Phase 4: プリセット複数連続実行モード 📚

**目標**: カテゴリ全体を順番に練習できる連続実行機能  
**成果物**: 全57種OLLなどを連続で練習可能

**実装項目**:
- [ ] `PatternSet`クラスの実装
- [ ] プリセットセット定義（全OLL、全PLL等）
- [ ] 連続実行用の状態変数管理
- [ ] プリセットセット選択画面のUI
- [ ] パターン準備・結果画面の進捗表示追加
- [ ] セット完了画面の実装
- [ ] スキップ・中断機能

詳細は[実装すべき項目](#実装すべき項目全体リスト)を参照。

---

### Phase 5: カスタムセット機能 🎨

**目標**: ユーザーが独自の練習セットを作成・管理  
**成果物**: カスタムセット作成・編集・実行

**実装項目**:
- [ ] `pattern_custom_sets`テーブル作成
- [ ] カスタムセット管理メソッド
- [ ] カスタムセット一覧・編集・追加画面のUI
- [ ] 苦手パターン識別機能
- [ ] セット保存・読み込み機能

詳細は[実装すべき項目](#実装すべき項目全体リスト)を参照。

---

### Phase 6: 統計表示と最適化 📊

**目標**: パターン統計の可視化と全体的な品質向上  
**成果物**: 完全な統計表示、パフォーマンス最適化

**実装項目**:
- [ ] Stats画面のタブ切り替え（Monthly / Pattern）
- [ ] パターン統計サマリー表示
- [ ] ソート・フィルタ機能
- [ ] 統計メソッドの完全実装（average, AO5, AO12等）
- [ ] パフォーマンス最適化
- [ ] Google Sheets連携
- [ ] UI/UX洗練

詳細は[実装すべき項目](#実装すべき項目全体リスト)を参照。

---

## フェーズ間の依存関係

```
Phase 1 (基盤構築) ✅ 完了
    ↓
Phase 1.5 (複数アルゴリズム対応) ✅ 完了
    ↓
Phase 2 (手動選択 + アルゴリズム選択) ✅ 完了 ← 最小機能完成
    ↓
Phase 3 (ランダム) ✅ 完了 ← Phase 2 の成果を利用
    ↓
Phase 4 (連続実行) 🔄 未着手 ← Phase 2, 3 の成果を利用
    ↓
Phase 5 (カスタム) 🔄 未着手 ← Phase 4 の連続実行機能を利用
    ↓
Phase 6 (統計・最適化) 🔄 未着手 ← 全フェーズの成果を統合
```

---

## 各フェーズ完了時の状態

| フェーズ | 動作する機能 | 使用可能なモード | 状態 |
|---------|------------|----------------|------|
| Phase 1 | なし（基盤のみ） | - | ✅ 完了 |
| Phase 1.5 | なし（データ構造拡張のみ） | - | ✅ 完了 |
| Phase 2 | パターン選択→アルゴリズム選択→練習→記録→評価 | 手動選択のみ | ✅ 完了 |
| Phase 3 | RANDタブからランダム練習、連続ランダム機能 | 手動選択、ランダム | ✅ 完了 |
| Phase 4 | プリセット連続実行 | 手動、ランダム、プリセット連続 | 🔄 未着手 |
| Phase 5 | カスタムセット | 全モード | 🔄 未着手 |
| Phase 6 | 完全な統計表示 | 全モード + 詳細統計 | 🔄 未着手 |

---

## 実装すべき項目（全体リスト）

### 1. 状態管理（states.py）
- [x] Phase 2で実装済みの状態
  - [x] `PATTERN_LIST_SELECT`、`PATTERN_ALGORITHM_SELECT`、`PATTERN_READY`、`PATTERN_FINISH`
- [ ] Phase 4以降の状態（未実装）
  - [ ] `PATTERN_MODE_SELECT` - 練習モード選択画面
  - [ ] `PATTERN_CUSTOM_SET_EDIT` - カスタムセット編集画面
- [x] Phase 2-3で実装済みの状態変数
  - [x] 現在のパターン、アルゴリズム、ランダムモード、重複回避履歴
- [ ] Phase 4以降の状態変数（未実装）
  - [ ] 実行中のパターンセット、パターンインデックス、進捗状況

### 2. パターンデータ管理
- [x] Phase 1-2で完了
  - [x] `Pattern`クラス、`Algorithm`クラス
  - [x] 78パターン（OLL: 57, PLL: 21）のJSON管理
  - [x] 複数アルゴリズム対応
- [x] Phase 2-3で完了
  - [x] ランダム選択（重複回避）、手動選択（ページ送り）
- [ ] Phase 4-5で実装予定
  - [ ] `PatternSet`クラス、プリセットセット定義、カスタムセット管理

### 3. データベース拡張
- [x] Phase 1-2で完了
  - [x] `pattern_solves`テーブル（algorithm_id含む）
  - [x] `user_pattern_preferences`、`user_algorithm_ratings`テーブル
  - [x] パターン別・アルゴリズム別統計メソッド
  - [x] ユーザー設定管理メソッド
- [ ] Phase 5で実装予定
  - [ ] `pattern_custom_sets`テーブル、カスタムセット管理メソッド
- [ ] Phase 6で実装予定
  - [ ] 統計メソッドの完全実装（average, AO5, AO12等）

### 4. UI/UX実装（renderer.py）
- [x] Phase 2-3で完了
  - [x] パターン選択画面（RAND/PLL/OLLタブ、ページ送り、循環）
  - [x] アルゴリズム選択画面、準備画面、結果画面
- [ ] Phase 4以降で実装予定
  - [ ] プリセットセット選択画面、進捗表示、セット完了画面
  - [ ] カスタムセット一覧・編集・追加画面
  - [ ] パターン統計画面（タブ切り替え、ソート、フィルタ）

### 5. 状態ハンドラ（state_handlers.py）
- [x] Phase 2-3で完了
  - [x] パターン選択、アルゴリズム選択、準備、完了ハンドラ
  - [x] RANDタブ対応、ランダムモード対応
- [ ] Phase 4以降で実装予定
  - [ ] プリセット連続実行ハンドラ、カスタムセット編集ハンドラ

### 6. Google Sheets連携拡張
- [ ] パターン練習用シート追加、記録同期処理

### 7. 設定・カスタマイズ
- [ ] パターン表示設定、自動次パターン機能、パターン順序設定

### 8. テスト項目
- [x] Phase 1-3のテスト完了
- [ ] Phase 4以降のテスト（連続実行、カスタムセット、統計、パフォーマンス等）

### 9. ドキュメント
- [ ] ユーザーガイド、開発者ドキュメント、設計ドキュメント

詳細なタスクリストは省略しますが、各Phase内に具体的な実装項目が記載されています。

---

## タイマー機能の拡充

既存のタイマー機能に対する改善・拡張項目

### 基本機能の改善
- [ ] 終了確認画面の作成
- [ ] 手動アップロード処理の作成
- [ ] タイマー表示の改善（デジタル時計風、パフォーマンス検証）
- [ ] サウンドの改善（明確なフィードバック、音量調整、カスタマイズ）

### データ管理
- [ ] ローカルDBからのレコード削除機能（個別、一括、確認ダイアログ）
- [ ] 画面読み込み処理（ローディングアニメーション、非同期）

### 設定・カスタマイズ
- [ ] 設定ファイル機能（色設定、自動保存、インポート/エクスポート）
- [ ] 設定画面の実装（オプション設定、キーバインド、テーマ）
- [ ] サイレントモードの実装

### UI/UX改善
- [ ] Stats画面の実装改善（詳細統計、グラフ表示）
- [ ] 画面遷移の実装改善（トランジション効果、アニメーション）
- [ ] メイン画面の表示改善（レイアウト最適化、可読性向上）

### セッション管理
- [ ] セッション選択UI、名前付け機能、統計比較

### 統計情報の視覚化
- [ ] グラフ表示（折れ線、棒グラフ）、タイム推移、記録分布

---

## 関連ドキュメント

- [フロー図（Mermaid形式）](flow_diagrams.md) - 画面遷移とデータフロー
- [README.md](../README.md) - プロジェクト概要と使い方
